phina.asset.AssetLoader.register("ks",function(a,b){var c=phina.novel.Script(b),d=c.load(b);return d}),phina.asset.AssetLoader.register("novel",function(a,b){var c=phina.novel.Script(b),d=c.load(b);return d}),phina.define("phina.novel.Script",{superClass:"phina.asset.Asset",init:function(){this.superInit(),this.tasks=[],this.tagTable=[],this.macros={}},_load:function(a){var b=this;phina.util.Ajax.request({responseType:"text",url:this.src}).then(function(c){b.extend(c,function(c){b.parse(c),a(b)})})},extend:function(a,b){var c=a.match(/[@\[]import path=(.*)/gm);if(!c||c.length<=0)return void(b&&b(a));var d=(this.src.split("?").last,[]);c.each(function(b){var c=phina.util.Flow(function(c){var d=b.replace(/[@\[\]]/g,""),e=d.match(/path=(.*)/)[1],f=phina.asset.File();f.load(e).then(function(d){a=a.replace(b,d.data),c(a)}.bind(this))}.bind(this));d.push(c)}.bind(this)),phina.util.Flow.all(d).then(function(){b&&b(a)})},parse:function(a){var b=this,c=this.tasks,d=a.split("\n");return d.each(function(a){a=a.trim();var d=a[0];if("*"==d){var e=a.trim(),f=c.length;b.tagTable[e]=f}else if(";"==d||"/"==a[0]&&"/"==a[1]);else if("@"==d)c.push(b._makeTag(a.substr(1)));else{for(var g=!1,h="",i="",j=0;j<a.length;++j){var k=a[j];1==g?"]"==k?(c.push(b._makeTag(h)),h="",g=!1):h+=k:0==g&&"["==k?(""!=i&&(c.push({type:"text",value:i.trim()}),i=""),g=!0):i+=k}""!=i&&(c.push({type:"text",value:i.trim()}),i="")}}),this},_makeTag:function(a){var b=a.split(" "),c=b.shift(),d={};b.each(function(a,b){var c=a.split("="),e=c[0],f=a.replace(e+"=","");return f.match(/^[+-]?[0-9]*[\.]?[0-9]+$/)?f=Number(f):"true"===f?f=!0:"false"===f&&(f=!1),d[e]=f});var e={type:"tag",func:c,params:d};return"macro"==c&&(this.macros[d.name]=e),e}}),phina.define("phina.novel.Layer",{superClass:"phina.display.DisplayElement",init:function(a){this.superInit(),this.images={}},addImage:function(a,b){this.images[a]=b,this.addChild(b)},getImage:function(a){return this.images[a]},removeImage:function(a){this.images[a].remove(),this.images[a]=null}});var BASIC_PROPS=["x","y","width","height","rotation","scaleX","scaleY","originX","originY","alpha"];phina.define("phina.novel.Element",{superClass:"phina.display.DisplayElement",elementMap:null,init:function(a,b){this.superInit(),"string"==typeof b?this.script=phina.asset.AssetManager.get(a,b):this.script=b,this.layers={base:phina.novel.Layer().addChildTo(this),0:phina.novel.Layer().addChildTo(this),1:phina.novel.Layer().addChildTo(this),2:phina.novel.Layer().addChildTo(this),message0:phina.novel.Layer().addChildTo(this),message1:phina.novel.Layer().addChildTo(this)},this.taskIndex=0,this.lockFlag=!1,this.chSpeed=1,this.variables={},this.localVariablesStack=[],this.taskStack=[],this.endifStack=[],this.labelArea=phina.ui.LabelArea({text:"",width:430,height:200,fill:"white"}).addChildTo(this.layers.message0),this.labelArea.text="",this.labelArea.origin.set(0,0),this.labelArea.x=20,this.labelArea.y=330,this.labelArea.fontSize=16,this.elementMap={},this.basePath="",this.set(0),this.setInteractive(!0),this.setBoundingType("all")},lock:function(){return this.lockFlag=!0,this},unlock:function(){return this.lockFlag=!1,this},jump:function(a){var b="string"==typeof a?this.script.tagTable[a]:a;return this.set(b),this},call:function(a){return this.localVariablesStack.push(this.activeTask.params),this.taskStack.push(this.taskIndex),this.jump(a),this},"return":function(){this.localVariablesStack.pop();var a=this.taskStack.pop()+1;this.set(a)},set:function(a){this.taskIndex=a,this.activeTask=this.script.tasks[this.taskIndex],this.seek=0,this.activeTask||(this.flare("taskfinish"),this.flare("finish"))},next:function(){this.set(this.taskIndex+1)},finish:function(){this.set(this.script.tasks.length)},format:function(a){if("string"!=typeof a)return a;var b={}.$extend(this.variables,this.localVariablesStack.last);return a=a.format(b),a.match(/^[+-]?[0-9]*[\.]?[0-9]+$/)?a=Number(a):"true"===a?a=!0:"false"===a&&(a=!1),/^[\[\(\{)]/.test(a)&&(a=JSON.parse(a)),a},macro:function(a){var b=this.script.macros[a],c=this.script.tasks.indexOf(b);this.call(c).next()},setVariable:function(a,b){return this.variables[a]=b,this},getVariable:function(a){return this.variables[a]},addNovelElement:function(a,b,c){void 0===c&&(c=1);var d=this.layers[c];return d.addChild(b),this.elementMap[a]=b,this},getNovelElement:function(a){var b=this.elementMap[a];return b},removeNovelElement:function(a){var b=this.elementMap[a];return b.remove(),this},updateTask:function(a){if(1!=this.lockFlag){var b=this.activeTask;if(b)if("text"==b.type){if(a.frame%this.chSpeed==0){0==this.seek&&(b.value=this.format(b.value));var c=b.value[this.seek++];if(void 0!==c){if(this.labelArea.text+=c,a.pointer.getPointingStart()){for(var d=this.seek,e=b.value.length;e>d;++d){var c=b.value[d];this.labelArea.text+=c}this.next()}}else this.next();this.flare("textupdate")}}else if("tag"==b.type){var f=phina.novel.Tag.get(b.func),g={};if(f){for(var h in b.params){var i=b.params[h];g[h]=this.format(i)}f.call(this,a,g),this.flare("taskrun",{task:b})}else this.script.macros[b.func]?this.macro(b.func):console.assert(f,"don't define `{0}`!".format(b.func));this.updateTask(a)}else alert()}},update:function(a){this.updateTask(a)}}),function(){phina.novel.Tag={map:{},get:function(a){return this.map[a]},set:function(a,b){if(1==arguments.length){var c=arguments[0];for(var a in c)this.map[a]=c[a]}else this.map[a]=b;return this}},phina.novel.Tag.set({log:function(a,b){var c=b.message||b.msg;console.log(c),this.next()},alert:function(a,b){var c=b.message||b.msg;alert(c),this.next()},debug:function(a,b){var c=b.message||b.msg;console.debug(c),this.next()},trace:function(app,params){console.log(eval(params.exp)),this.next()},"var":function(a,b){var c=b.value;this.variables[b.key]=c,this.next()},"if":function(app,params){var exp=params.exp,rst=eval(exp);if(1==!!rst){for(var tasks=this.script.tasks,i=this.taskIndex+1,len=tasks.length;len>i;++i){var task=tasks[i];if("endif"==task.func){this.endifStack.push(i);break}}this.next()}else for(var tasks=this.script.tasks,i=this.taskIndex+1,len=tasks.length;len>i;++i){var task=tasks[i];if("endif"==task.func||"elseif"==task.func||"else"==task.func){this.set(i);break}}},elseif:function(app,params){if(this.endifStack.last)return void this.set(this.endifStack.last);var exp=params.exp,rst=eval(exp);if(1==!!rst){for(var tasks=this.script.tasks,i=this.taskIndex+1,len=tasks.length;len>i;++i){var task=tasks[i];if("endif"==task.func){this.endifStack.push(i);break}}this.next()}else for(var tasks=this.script.tasks,i=this.taskIndex+1,len=tasks.length;len>i;++i){var task=tasks[i];if("endif"==task.func||"elseif"==task.func||"else"==task.func){this.set(i);break}}},"else":function(a,b){return this.endifStack.last?void this.set(this.endifStack.last):void this.next()},endif:function(a,b){this.endifStack.pop(),this.next()},macro:function(a,b){for(var c=this.script.tasks,d=this.taskIndex+1,e=c.length;e>d;++d){var f=c[d];if("endmacro"==f.func){this.set(d);break}}this.next()},endmacro:function(a,b){this["return"]()},l:function(a,b){this.lock(),this.onpointstart=function(){this.onpointstart=null,this.unlock(),this.next()}.bind(this)},wait:function(a,b){this.lock();var c=phina.accessory.Tweener().attachTo(this);c.clear().wait(b.time).call(function(){this.unlock(),this.next()}.bind(this))},delay:function(a,b){this.chSpeed=b.speed*(a.fps/1e3)|0,this.chSpeed=Math.max(this.chSpeed,1),this.next()},jump:function(a,b){this.jump(b.target)},call:function(a,b){this.call(b.target)},"return":function(a,b){this["return"]()},reload:function(a,b){this.lock(),this.script.reload(),this.script.onload=function(){this.unlock(),this.next()}.bind(this)},event:function(a,b){b.name=b.name,this.flare("novelevent",b),this.next()},s:function(a,b){this.finish()}})}(),function(){phina.novel.Tag.set({r:function(a,b){this.labelArea.text+="\n",this.next()},cm:function(a,b){this.labelArea.text="",this.next()},position:function(a,b){var c=this.labelArea;void 0!==b.x&&(c.x=b.x),void 0!==b.y&&(c.y=b.y),void 0!==b.width&&(c.width=b.width),void 0!==b.height&&(c.height=b.height),b.vertical===!0&&(c.mode="vertical"),this.next()},font:function(a,b){var c=this.labelArea;void 0!==b.size&&(c.fontSize=b.size),void 0!==b.color&&(c.fill=b.color),void 0!==b.face&&(c.fontFamily=b.face),void 0!==b.lineSpace&&(c.lineSpace=b.lineSpace),void 0!==b.lineHeight&&(c.lineHeight=b.lineHeight),this.next()}})}(),function(){phina.novel.Tag.set({base:function(a,b){this.basePath=b.path.format(this.variables),this.next()},load:function(a,b){this.lock();var c=b.type,d=b.name,e=b.path.format(this.variables);e=this.basePath?this.basePath+"/"+e:e,console.log(e);var f={};f[d]=e;var g={};g[c]=f;var h=phina.asset.AssetLoader();h.onload=function(){this.unlock(),this.next()}.bind(this),h.load(g)}})}(),function(){phina.novel.Tag.set({"new":function(a,b){var c=phina.using(b.type);if(b.arg instanceof Array)var d=c.apply(null,b.arg);else var d=c.call(null,b.arg);this.addNovelElement(b.name,d,b.layer),BASIC_PROPS.each(function(a){var c=b[a];void 0!==c&&(d[a]=c)}),this.next()},set:function(a,b){var c=this.getNovelElement(b.name),d=b.key,e=b.value;d&&(c[d]=e),BASIC_PROPS.each(function(a){var d=b[a];void 0!==d&&(c[a]=d)}),this.next()},exec:function(a,b){var c=this.getNovelElement(b.name);b.arg instanceof Array?c[b.method].apply(c,b.arg):c[b.method].call(c,b.arg),this.next()},"delete":function(a,b){this.removeNovelElement(b.name);this.next()},image_show:function(a,b){var c=phina.display.Sprite(b.name);this.addNovelElement(b.name,c,b.layer),void 0!==b.x&&(c.x=b.x),void 0!==b.y&&(c.y=b.y),void 0!==b.originX&&(c.originX=b.originX),void 0!==b.originY&&(c.originY=b.originY),void 0!==b.width&&(c.width=b.width),void 0!==b.height&&(c.height=b.height),c.show(),c.alpha=0,c.tweener.clear().fadeIn(250).call(function(){}),this.next()},image_hide:function(a,b){var c=this.getNovelElement(b.name);this.lock(),c.tweener.clear().fadeOut(250).call(function(){this.removeNovelElement(b.name),this.unlock(),this.next()}.bind(this))},shape:function(a,b){var c=b.type,d=this.layers[b.layer||1],e=null;switch(c){case"rect":e=phina.display.RectangleShape({width:b.width,height:b.height,stroke:"transparent",fill:b.color});break;default:console.log("そんなタイプないよ!")}d.addImage(b.name,e),e.x=b.x,e.y=b.y,e.alpha=0,e.tweener.clear().fadeIn(250),this.next()},anim:function(a,b){var c=b.time||1e3,d=b.easing,e=this.getNovelElement(b.name),f=e.tweener,g={};BASIC_PROPS.each(function(a){void 0!==b[a]&&(g[a]=b[a])}),f.clear().to(g,c,d),this.next()},anim_by:function(a,b){var c=b.time||1e3,d=b.easing,e=this.getNovelElement(b.name),f=e.tweener,g={};BASIC_PROPS.each(function(a){void 0!==b[a]&&(g[a]=b[a])}),f.clear().by(g,c,d),this.next()}})}(),function(){phina.novel.Tag.set({sound_play:function(a,b){var c=this,d=phina.asset.AssetManager.get("sound",b.name);b.wait===!0?(this.lock(),d.onended=function(){c.unlock(),c.next()}):this.next(),d.play()},music_play:function(a,b){phina.asset.AssetManager.get("sound",b.name).setLoop(!0).play(),this.next()},music_stop:function(a,b){phina.asset.AssetManager.get("sound",b.name).stop()}})}(),phina.novel.Tag.set({select_start:function(a,b){this.options=[],this.next()},select_option:function(a,b){this.options.push({}.$extend(b)),this.next()},select_end:function(a,b){var a=this.getRoot().app,c=phina.novel.SelectScene({width:a.width,height:a.height,options:this.options});c.onselect=function(a){this.unlock();var b=this.options[a.selectIndex];b.tag?this.macro(b.tag):b.target?this.call(b.target):console.error("error!")}.bind(this),a.pushScene(c),this.lock()}}),phina.define("phina.novel.SelectScene",{superClass:"phina.app.Scene",init:function(a){this.superInit(),this.fromJSON({children:{bg:{type:"phina.display.RectangleShape",init:[SCREEN_WIDTH,SCREEN_HEIGHT,{fill:"rgba(40, 40, 40, 0.5)"}],originX:0,originY:0}}}),a.options.each(function(b,c){var d=phina.ui.FlatButton({text:b.text,bgColor:"hsl(220, 80%, 60%)",fontColor:"#555",fontSize:27,width:220,height:70}).addChildTo(this);d.x=a.width/2,d.y=a.height/2+83*c,d.onpointingend=function(){this.bg.tweener.clear().fadeOut(100).call(function(){var a={selectIndex:c};this.flare("select",a),this.app.popScene()},this)}.bind(this)},this),this.bg.alpha=0,this.bg.tweener.fadeIn(100)}});